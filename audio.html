<!DOCTYPE html>
<html>
<head>
    <title>Audio Recorder</title>
</head>
<body>
    <button id="recordButton">Record</button>
    <p id="status"></p>
    <ul id="recordingsList"></ul>
    <script>
        let mediaRecorder;
        let audioChunks = [];

        const recordButton = document.getElementById("recordButton");
        const statusElement = document.getElementById("status");
        const recordingsList = document.getElementById("recordingsList");
        let isRecording = false;

        // WebSocket connection
        const ws = new WebSocket('ws://localhost:8080');
        ws.binaryType = 'arraybuffer';

        ws.onopen = function () {
            console.log("Connected to the WebSocket server!");
        };

        ws.onerror = function (error) {
            console.error('WebSocket Error: ', error);
        };

        ws.onclose = function(event) {
            console.log(`WebSocket is closed now. Code: ${event.code}, reason: ${event.reason}`);
        };

        recordButton.addEventListener("click", () => {
            if (!isRecording) {
                startRecording();
            } else {
                stopRecording();
            }
        });

        async function startRecording() {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.start();

            mediaRecorder.addEventListener("dataavailable", event => {
                audioChunks.push(event.data);
            });

            mediaRecorder.addEventListener("stop", () => {
                const audioBlob = new Blob(audioChunks, { 'type' : 'audio/wav' });
                const audioUrl = URL.createObjectURL(audioBlob);
                const audio = new Audio(audioUrl);
                const listItem = document.createElement("li");
                listItem.appendChild(audio);
                recordingsList.appendChild(listItem);
                audioChunks = [];

                if (ws.readyState === WebSocket.OPEN) {
                    const reader = new FileReader();
                    reader.onloadend = function() {
                        const audioBuffer = reader.result;

                        // Sending the binary audio data directly to the WebSocket server
                        ws.send(audioBuffer);

                        // Prepare and send the metadata
                        const metadata = {
                            media: {
                                track: "recording.wav", // Replace with your actual track identifier
                                timestamp: new Date().toISOString(), // ISO format timestamp
                                payload: "" // Payload would be handled separately; filled in if required
                            },
                            sequenceNumber: "0" // Placeholder for sequence number, update accordingly
                        };

                        // Send metadata as a JSON string
                        ws.send(JSON.stringify(metadata));
                        statusElement.textContent = "Recording sent!";
                    };
                    reader.readAsArrayBuffer(audioBlob);
                } else {
                    console.error('WebSocket is not open. Cannot send data.');
                    statusElement.textContent = "Failed to send recording!";
                }
            });

            isRecording = true;
            recordButton.textContent = "Stop Recording";
            statusElement.textContent = "Recording...";
        }

        function stopRecording() {
            mediaRecorder.stop();
            isRecording = false;
            recordButton.textContent = "Record";
            statusElement.textContent = "";
        }
    </script>
</body>
</html>
