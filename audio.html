<!DOCTYPE html>
<html>
<head>
    <title>Audio Recorder</title>
</head>
<body>
    <button id="recordButton">Record</button>
    <p id="status"></p>
    <ul id="recordingsList"></ul>
    <script>
        let mediaRecorder;
        let audioChunks = [];

        const recordButton = document.getElementById("recordButton");
        const statusElement = document.getElementById("status");
        const recordingsList = document.getElementById("recordingsList");
        let isRecording = false;

        // WebSocket connection
        const ws = new WebSocket('ws://localhost:8080');
        ws.binaryType = 'arraybuffer';

        ws.onopen = function () {
            console.log("Connected to the WebSocket server!");
        };

        ws.onerror = function (error) {
            console.error('WebSocket Error: ', error);
        };

        ws.onclose = function(event) {
            console.log(`WebSocket is closed now. Code: ${event.code}, reason: ${event.reason}`);
        };

        recordButton.addEventListener("click", () => {
            if (!isRecording) {
                startRecording();
            } else {
                stopRecording();
            }
        });

        async function startRecording() {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.start();

            mediaRecorder.addEventListener("dataavailable", event => {
                audioChunks.push(event.data);
            });

            mediaRecorder.addEventListener("stop", () => {
                const audioBlob = new Blob(audioChunks, { 'type' : 'audio/wav' });
                const audioUrl = URL.createObjectURL(audioBlob);
                const audio = new Audio(audioUrl);
                const listItem = document.createElement("li");
                listItem.appendChild(audio);
                recordingsList.appendChild(listItem);
                audioChunks = [];

                if (ws.readyState === WebSocket.OPEN) {
                    // First, send a JSON metadata object if the server expects it
                    const metadata = JSON.stringify({ filename: "recording.wav", filetype: "audio/wav" });
                    ws.send(metadata);
                    // Then, send the binary audio blob data directly to the WebSocket server
                    ws.send(audioBlob);
                    statusElement.textContent = "Recording sent!";
                } else {
                    console.error('WebSocket is not open. Cannot send data.');
                    statusElement.textContent = "Failed to send recording!";
                }
            });

            isRecording = true;
            recordButton.textContent = "Stop Recording";
            statusElement.textContent = "Recording...";
        }

        function stopRecording() {
            mediaRecorder.stop();
            isRecording = false;
            recordButton.textContent = "Record";
            statusElement.textContent = "";
        }
    </script>
</body>
</html>
